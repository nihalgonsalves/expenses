name: build
on: [push]
jobs:
  build:
    timeout-minutes: 5
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # https://www.chromatic.com/docs/github-actions/
          fetch-depth: 0
      # waiting on: https://github.com/actions/setup-node/issues/531
      - run: corepack enable
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn

      - run: yarn install --immutable
      - run: yarn build

      - run: yarn fe build:storybook
      - name: Publish to Chromatic
        uses: chromaui/action@latest
        with:
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
          storybookBuildDir: ./packages/frontend/build/storybook/
          autoAcceptChanges: main
          exitOnceUploaded: true

      - run: yarn lint
      - uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: ./infra/Dockerfile-backend
      - uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: ./infra/Dockerfile-frontend

  test:
    timeout-minutes: 20
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      # waiting on: https://github.com/actions/setup-node/issues/531
      - run: corepack enable
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn

      # pull so that testcontainers doesn't have to, timing out tests.
      - run: docker compose -f compose.dev.yaml pull postgres redis

      - run: yarn install --immutable
      - run: yarn test --coverage

      - run: yarn be prepare:e2e
      - run: yarn e2e prepare-pw

      - run: docker compose build --pull
      - run: docker compose up postgres --wait --detach
      - run: docker compose run --rm backend yarn prisma migrate deploy
      - run: docker compose up --detach backend

      - run: yarn e2e test

      - if: always()
        run: docker compose down --volumes

      - if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - uses: codecov/codecov-action@v3
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
