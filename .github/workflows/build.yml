name: build
on: [push]
jobs:
  build:
    timeout-minutes: 5
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # https://www.chromatic.com/docs/github-actions/
          fetch-depth: 0
      # waiting on: https://github.com/actions/setup-node/issues/531
      - run: corepack enable
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn

      - run: yarn install --immutable
      - run: yarn build

      - run: yarn fe build:storybook
      - name: Publish to Chromatic
        uses: chromaui/action@latest
        with:
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
          storybookBuildDir: ./packages/frontend/build/storybook/

      - run: yarn lint
      - uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: ./infra/Dockerfile-backend
      - uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: ./infra/Dockerfile-frontend

  test:
    timeout-minutes: 5
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      # waiting on: https://github.com/actions/setup-node/issues/531
      - run: corepack enable
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn
      # pull so that testcontainers doesn't have to, timing out tests.
      - run: docker compose -f compose.dev.yaml pull postgres redis
      - run: yarn install --immutable
      - run: yarn test
