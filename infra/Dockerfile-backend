FROM node:20-slim as builder

# hadolint ignore=DL3008
RUN apt-get update -y && \
  apt-get install -y --no-install-recommends \
    # for prisma
    openssl \
  && rm -rf /var/lib/apt/lists/*

RUN mkdir -p /opt/app
WORKDIR /opt/app

COPY package.json .
COPY ./packages/frontend/package.json ./packages/frontend/
COPY ./packages/backend/package.json ./packages/backend/
COPY ./packages/shared/package.json ./packages/shared/
COPY yarn.lock .

RUN corepack enable
RUN yarn install --immutable && yarn cache clean

COPY ./tsconfig.json ./tsconfig.base.json ./
COPY ./packages/frontend/ ./packages/frontend/
COPY ./packages/backend/ ./packages/backend/
COPY ./packages/shared/ ./packages/shared/

ENV NODE_ENV=production

RUN yarn be build

FROM node:20-slim

# hadolint ignore=DL3008
RUN apt-get update -y && \
  apt-get install -y --no-install-recommends \
    # for prisma
    openssl \
  && rm -rf /var/lib/apt/lists/*

COPY --from=builder /opt/app/packages/backend/dist /opt/app
WORKDIR /opt/app

COPY --from=builder /opt/app/packages/backend/prisma ./prisma

RUN yarn install && yarn cache clean

ENV NODE_ENV=production

USER node

CMD ["node", "--enable-source-maps", "/opt/app/app.js"]
